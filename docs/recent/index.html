<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Ultime 30 partite</title>
<style>body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    nav a { margin-right: 12px; }
    textarea { width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; vertical-align: top; }
    .error { background: #ffe8e8; padding: 10px; border: 1px solid #ffb3b3; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
    .muted { color: #666; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .row > div { flex:1; min-width: 220px; }
    button { cursor:pointer; }</style>
</head>
<body>
<nav><a href="/commander-tracker/">Home</a>
<a href="/commander-tracker/recent/">Ultime 30</a>
<a href="/commander-tracker/summary/">Summary</a>
<a href="/commander-tracker/triplette/">Decks info</a>
<a href="/commander-tracker/stats/">Statistiche</a>
<a href="/commander-tracker/dashboard_mini/">Dashboard</a>
<a href="/commander-tracker/dashboard_mini_bracket/">Dashboard (Bracket)</a>
<a href="/commander-tracker/player_dashboard/">Player</a>
<a href="/commander-tracker/export.csv">Export CSV</a></nav>
<hr/>
<h1>Ultime 30 partite</h1>
<p class="muted">Pagina statica (GitHub Pages). Filtra per player o commander e scorri le partite più recenti.</p>
<div class="card">
<label for="q"><b>Filtro</b></label><br/>
<input id="q" placeholder="Es: Luca / Atraxa / bracket 3…" style="width:min(520px, 100%);"/>
<div class="muted" style="margin-top:8px;">Suggerimento: puoi cercare anche per <i>winner</i> e per <i>note</i>.</div>
</div>
<table>
<thead>
<tr>
<th>Data (UTC)</th>
<th>Partecipanti</th>
<th>Winner</th>
<th>Lineup</th>
<th>Note</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
<script>
    const BASE = "/commander-tracker/";
    let games = [];

    function esc(s) {
      return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function fmtLineup(lineup) {
      if (!Array.isArray(lineup) || !lineup.length) return '';
      return lineup.map(e => {
        const br = (e.bracket === null || e.bracket === undefined || e.bracket === '') ? '' : ` (B${e.bracket})`;
        return `${esc(e.player)} = ${esc(e.commander)}${esc(br)}`;
      }).join('<br/>');
    }

    function row(g) {
      const dt = esc(g.played_at_utc || '');
      const parts = esc(g.participants ?? '');
      const win = esc(g.winner_player || '');
      const notes = esc(g.notes || '');
      return `<tr>
        <td style="white-space:nowrap;">${dt}</td>
        <td style="text-align:right;">${parts}</td>
        <td>${win}</td>
        <td>${fmtLineup(g.lineup)}</td>
        <td>${notes}</td>
      </tr>`;
    }

    function render() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const rows = q
        ? games.filter(g => {
            const blob = `${g.played_at_utc} ${g.winner_player} ${g.notes} ` +
              (Array.isArray(g.lineup) ? g.lineup.map(e => `${e.player} ${e.commander} ${e.bracket ?? ''}`).join(' ') : '');
            return blob.toLowerCase().includes(q);
          })
        : games;
      document.getElementById('tb').innerHTML = rows.map(row).join('');
    }

    fetch(BASE + 'data/recent_games.json')
      .then(r => r.json())
      .then(j => { games = j.games || []; render(); });

    document.getElementById('q').addEventListener('input', render);
  </script>
</body>
</html>